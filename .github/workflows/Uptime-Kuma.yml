name: 自动构建包含 node_modules 的 Uptime Kuma，用于内存受限的托管平台

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Get latest version
        id: version
        run: |
          LATEST=$(curl -s https://api.github.com/repos/louislam/uptime-kuma/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest version: $LATEST"
      
      - name: Check if exists
        id: check
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION || echo "")
          if echo "$RELEASE" | grep -q '"id"'; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Clone Uptime Kuma
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git clone --depth 1 --branch $VERSION https://github.com/louislam/uptime-kuma.git
      
      - name: Install dependencies and build
        if: steps.check.outputs.exists == 'false'
        run: |
          cd uptime-kuma
          npm ci --legacy-peer-deps
          npm run build
          echo "✓ Frontend built"
      
      - name: Reinstall production only
        if: steps.check.outputs.exists == 'false'
        run: |
          cd uptime-kuma
          rm -rf node_modules
          npm ci --omit=dev --legacy-peer-deps
      
      - name: Clean up
        if: steps.check.outputs.exists == 'false'
        run: |
          cd uptime-kuma
          
          # 只删除确定不需要的文件
          rm -rf .git .github .vscode test docker
          rm -f *.md CNAME compose.yaml 2>/dev/null || true
          rm -f .dockerignore .editorconfig .gitignore 2>/dev/null || true
          
          # 保留 src 目录（服务器需要）
          # 保留 dist 目录（前端构建）
          # 保留 server 目录
          # 保留 db 目录
          # 保留 extra 目录
          
          # 清理 node_modules 中不需要的文件
          find node_modules -name "*.md" -type f -delete 2>/dev/null || true
          find node_modules -name "*.map" -type f -delete 2>/dev/null || true
          find node_modules -name "LICENSE*" -type f -delete 2>/dev/null || true
          find node_modules -name "CHANGELOG*" -type f -delete 2>/dev/null || true
          find node_modules -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name ".github" -exec rm -rf {} + 2>/dev/null || true
          
          echo "=== Final structure ==="
          ls -la
          echo "=== dist ==="
          ls -la dist/ | head -10
          echo "=== src ==="
          ls -la src/ | head -10
          echo "=== server ==="
          ls -la server/ | head -10
      
      - name: Package
        if: steps.check.outputs.exists == 'false'
        run: |
          tar -czvf uptime-kuma-${{ steps.version.outputs.version }}.tar.gz uptime-kuma
          ls -lh uptime-kuma-*.tar.gz
      
      - name: Create Release
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Uptime Kuma ${{ steps.version.outputs.version }}
          body: |
            Pre-built Uptime Kuma ${{ steps.version.outputs.version }}
            
            ✅ Includes:
            - Built frontend (dist/)
            - Source files (src/)
            - Server files (server/)
            - Production node_modules
            
            For low-memory hosting platforms.
          files: uptime-kuma-${{ steps.version.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
